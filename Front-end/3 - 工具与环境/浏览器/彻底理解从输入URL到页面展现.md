# 彻底理解从输入URL到页面展现的过程
### 流程概述
地址栏输入url ——> 域名解析 ——> 服务器处理请求 ——> 浏览器处理响应 ——> 浏览器绘制网页

## 一、地址栏输入URL
### 1. 认识URL
**定义：** URL（Uniform Resource Locator）统一资源**定位符**，用于定位网络上的资源，实际上就是网站的网址。
> URI（Uniform Resource Identifier）统一资源**标识符**，是一类用于标示物理资源的字符串。URL是URI的一种子集，URL的不同在于，它除了确定一个资源，还提供了一种定位该资源的访问机制（如http://）。

**标准格式：**
三部分：协议类型、主机域名、存放路径及文件名
`scheme://[host.]domain[:port]/path/filename`
* **scheme** - 资源的因特网服务协议类型，常见的有http、https、ftp(文件传输协议)等；
* **host** - 域主机类型，省略时取默认值，http/https默认值为www；
* **domain** - 英特网域名，如w3school.com.cn；
* **:port** - 端口号，省略时取默认值，http默认为80，https默认为443；
* **path** - 资源存放路径，若省略则资源必须位于网站根目录中；
* **filename** - 资源文件名。

例如，我的github前端知识库项目主页为 https://github.com/Zhang-jerry/KBS ，其中，https表示与web服务器通讯采用https协议，github的web服务器域名为 www.github.com，省略了域主机host(www)，端口号取了默认值443，/Zhang-jerry指定了页面在服务器上的存放路径，/KBS指定了项目主页在服务器中的文件名称。

**端口的作用：** 一台主机常同时作为Web、FTP等服务器使用，端口编号用来告诉主机要将请求交给哪个服务器。默认情况下http服务的端口为80，不需要在url中输入，如果web服务器采用的不是这一个默认端口，就需要写明服务器所用的端口。常见的协议默认端口如下：
|协议类型|默认端口
|--------|--------
|http|80
|https|443
|ftp|21
|telnet|23

### 2. 认识IP地址
> 每个抛头露面的域名背后总有一个低调内敛的IP。

**IP：** 是因特网中每台计算机为实现相互通信而遵循的规则协议。每个处于互联网中的设备都有IP地址，每个网站就是靠服务器的IP地址来定位的。

**域名：** 可以理解成“为了方便记忆而为IP地址起的一个小名”，人们使用域名来登录网站，每个域名背后有对应的IP地址。

例如，github的URL为 https://github.com，其域名为 github.com，其实浏览器并不知道github.com是什么鬼，要访问该网站，就需要查找该域名所代表的IP地址（即github网站服务器的IP地址），这个查找的过程即为**域名解析**。

## 二、域名解析
域名解析是一个层级查找的过程：
查找浏览器缓存 ——> 查找操作系统缓存 ——> 查找路由器缓存 ——> 查找本地DNS缓存 ——> 递归查询
（DNS：域名和IP地址相互映射的一个分布式数据库）

**具体来说：**

 1. **浏览器缓存**

    浏览器查找缓存中是否之前解析过并缓存了这个域名的IP地址。
    如果有，浏览器获得该IP，解析过程结束，如果没有，继续查找操作系统缓存。

 2. **操作系统缓存**

    浏览器查找操作系统hosts文件中是否有目标域名和对应的IP地址。
    如果有，浏览器获得该IP，解析过程结束，如果没有，继续查找路由器缓存。

 3. **路由器缓存**

    路由器一般会有自己的DNS缓存，浏览器到路由器DNS缓存中查找。
    如果有，浏览器获得该IP，解析过程结束，如果没有，继续查找本地DNS缓存。

 4. **本地DNS缓存**

    网络配置中都会有"DNS服务器地址"这一项，浏览器会把这个域名发送给这里设置的DNS服务器，也就是本地区的域名服务器，通常是给你提供接入互联网的运营商。114.114.114.114是国内移动、电信和联通通用的DNS。
    如果有，浏览器获得该IP，解析过程结束，如果没有，继续进行递归查找。

 5. **递归查找**

    * 本地DNS服务器将目标域名转发到互联网上的根域
    * 根域将所要查询域名中的顶级域（比如www.baidu.com的顶级域就是com）的服务器IP地址返回给本地DNS。
    * 本地DNS根据返回的顶级域IP地址，向顶级域服务器发送目标域名，顶级域服务器再将域名中的二级域（比如www.baidu.com的二级域为baidu.com）的服务器IP地址返回给本地DNS。
    * 本地DNS根据返回的二级域IP地址，向二级域服务器发送目标域名，重复这样的过程，直到本地DNS获得完整的服务器IP地址，并返回给浏览器。

    下图展示了完整的递归查询过程：
    ![dns.png](https://i.loli.net/2019/06/02/5cf372c2c1c4415893.png)

获得完整的服务器IP地址后，域名解析环节完成。之后，将用户发起的http请求发送给该IP对应的服务器，等待服务器处理请求。

## 三、服务器处理请求
服务器上安装了处理http请求的应用 —— web server，常见的web server产品有apache、nginx、IIS、Lighttpd等。

当web server接收到一个HTTP请求(request)，会结合配置文件，把不同请求委托给服务器上处理对应请求的程序进行处理（例如CGI脚本、JSP脚本、servlets、ASP脚本、服务器端JavaScript、或者一些其它的服务器端技术等）。不管是哪种脚本，这些服务器端(server-side)程序都会产生一个http响应(response)，例如送回一个HTML页面，来让浏览器可以展现。

完成处理过程的代码框架，大部分是按照MVC设计模式搭建的，实际处理过程如下图：
![MVC.png](https://i.loli.net/2019/06/02/5cf374fb82fba19889.png)

MVC的处理过程是这样的：每个用户输入的请求，首先被控制器(C)接收，控制器决定用哪个模型(M)来处理，然后模型用业务逻辑来处理用户的请求，再然后控制器决定用哪个视图模型(V)来接收模型处理后的数据，最后由该视图模型对应的视图格式化模型来返回HTML字符串给浏览器。

## 四、浏览器处理响应
浏览器接收到后台返回的HTML字符串后，会依次经历：加载、解析、渲染。

* **加载：** 浏览器对一个html文件的加载顺序是从上而下的。
当加载到外部css文件、图片等资源，浏览器会再发起一次http请求，来获取外部资源，这类静态资源不会阻塞线程。
当加载到js文件，html文档会挂起渲染（加载解析渲染同步）的线程，等待js文件加载、解析完毕才可以恢复html文档的渲染线程。这也是为什么尽量将script标签放在body闭合标签前。

* **解析：** 解析文档是指将文档转化成为浏览器可识别的代码。
    - HTML解析得到的是DOM树，也称节点树，如下图：
    ![html.png](https://i.loli.net/2019/06/02/5cf379ad01fd675039.png)

    - css解析得到的是样式表对象，如下图：
    ![css.png](https://i.loli.net/2019/06/02/5cf37959b269189230.png)

    - js是一种动态语言，无需编译，其解析过程即为其“预编译”、“预处理”过程。

* **渲染：** 构建渲染树的过程，就是将DOM树进行可视化表示。构建这棵树是为了以正确的顺序绘制文档内容。

## 五、浏览器绘制网页
绘制过程主要是html(结构)与css(样式)的结合，以及js(行为)动态效果的展现。
css是通过选择器与html结合的，html自身不带有任何样式。